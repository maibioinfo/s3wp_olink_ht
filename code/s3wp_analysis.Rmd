---
title: 'S3WP analysis (2024)'
output: html_document
date: '2024-12-03'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# import functions
source('C:/Users/maihu/wellness/code/functions.R')
# import require lib
library(dplyr)
library(impute)
library(openxlsx)
library(ggplot2)
library(umap)
library(tidyr)
library(stringr)
library(effectsize)
```

## Read data

Read in data for Olink HT, Olink Target, subject information, subject IDs and meta data.
```{r read data}
# Read in data
olink_ht_raw = read.csv('C:/Users/maihu/wellness/data/onlink_ht/olink_ht.csv', header = T)
olink_target = read.delim('C:/Users/maihu/wellness/data/olink_target/olink_target.txt', sep = '\t', header = T)
subject_info = read.xlsx('C:/Users/maihu/wellness/data/onlink_ht/subjects_2024-11-21.xlsx', sheet = 1)
target_id = read.csv('C:/Users/maihu/wellness/data/Annoteringsfil_Olink.csv', header = T, sep = ';')
```

## Olink HT warning filter

Quality control: filter samples and proteins with warnings > 50% for Olink HT data

```{r ht warning filter}
# Calculate warning counts
sample_warning_counts = calculate_sample_warnings(olink_ht_raw)
protein_warning_counts = calculate_protein_warnings(olink_ht_raw)

# Filter samples with > 50% warnings
olink_ht_fil1 = filter_samples(olink_ht_raw, sample_warning_counts)

# Filter proteins with > 50% warnings
olink_ht_fil2 = filter_proteins(olink_ht_fil1, protein_warning_counts)
```

## Olink HT replicate assay 

QC: select the highest LOD among replicate assays 
Proteins with multiple measurements: 
- GBP1 (UniProt: P32455): Block 3 highest LOD 
- MAP2K1 (UniProt: Q02750): Block 4 highest LOD

```{r ht replicate assay}
# Filtered by UniProt 
gbp1_measurements = filter_by_column_value(olink_ht_fil2, 'UniProt', 'P32455')
map2k1_measurements = filter_by_column_value(olink_ht_fil2, 'UniProt', 'Q02750')

# There are multiple blocks for these proteins, separate by blocks to see LOD distribution
divide_df_by_column(gbp1_measurements, 'Block')
divide_df_by_column(map2k1_measurements, 'Block')

# LOD distribution 
plot_lod_distribution(data = gbp1_measurements_Block3, lod_col = 'LOD', lod_type = 'GBP1 Block 3') 
plot_lod_distribution(data = gbp1_measurements_Block4, lod_col = 'LOD', lod_type = 'GBP1 Block 4')
plot_lod_distribution(data = gbp1_measurements_Block5, lod_col = 'LOD', lod_type = 'GBP1 Block 5')
plot_lod_distribution(data = map2k1_measurements_Block3, lod_col = 'LOD', lod_type = 'MAP2K1 Block 3')
plot_lod_distribution(data = map2k1_measurements_Block4, lod_col = 'LOD', lod_type = 'MAP2K1 Block 4')
plot_lod_distribution(data = map2k1_measurements_Block5, lod_col = 'LOD', lod_type = 'MAP2K1 Block 5')

# Filter low LOD assays
olink_ht = olink_ht_fil2 %>%  filter(!(UniProt == 'P32455' & (Block == 4 | Block == 5)))
olink_ht = olink_ht %>%  filter(!(UniProt == 'Q02750' & (Block == 3 | Block == 5)))

```

## Olink HT LOD analysis

Assess the LOD of all samples

```{r ht LOD analysis}
# LOD distribution plot to assess quality
plot_lod_distribution(data = olink_ht_fil2, lod_col = 'LOD', lod_type = 'Olink HT')

# Test how many protein detected more than LOD
olink_ht_fil2 = olink_ht_fil2 %>% mutate(under_LOD = ifelse(is.na(NPX) | NPX < LOD, 'Yes', 'No'))
olink_ht_fil2$under_LOD = as.factor(olink_ht_fil2$under_LOD)

# Number of protein compared with LOD
protein_detected_100 = analyze_proteins(olink_ht_fil2)
protein_detected_80 = analyze_proteins(olink_ht_fil2, detection_percentage = 80)

# Per protein, calculate the percentage of samples detected above LOD
protein_LOD_comparison = olink_ht_fil2 %>% group_by(UniProt) %>% summarise(
    more_than_LOD = sum(under_LOD == "No"), total_samples = n(),
    percent_more_than_LOD = round((more_than_LOD / total_samples) * 100, 2)) %>%
  select(UniProt, more_than_LOD, percent_more_than_LOD) %>% arrange(desc(percent_more_than_LOD))

# Separate 0% into one bin
protein_LOD_comparison = protein_LOD_comparison %>%
  mutate(percent_more_than_LOD = ifelse(percent_more_than_LOD == 0, -1, percent_more_than_LOD))
# Maximum count to have adaptive y axis
max_count = max(hist(ifelse(protein_LOD_comparison$percent_more_than_LOD == 0, -1, 
                            protein_LOD_comparison$percent_more_than_LOD), 
                     breaks = seq(-5, 105, by = 5), plot = FALSE)$counts)
# Above LOD percentage histogram
ggplot(protein_LOD_comparison, aes(x = ifelse(percent_more_than_LOD == 0, -1, percent_more_than_LOD))) +
  geom_histogram(binwidth = 5, fill = 'skyblue', color = 'black', alpha = 0.7, boundary = 0, closed = 'left') +
  geom_segment(aes(x = 0, xend = 0, y = 0, yend = max_count), color = 'red', linetype = 'dashed', size = 0.6, inherit.aes = FALSE) +
  geom_segment(aes(x = 50, xend = 50, y = 0, yend = max_count), color = 'blue', linetype = 'dashed', size = 0.6, inherit.aes = FALSE) +
  labs(title = 'Distribution of percentage above LOD', x = 'Proteins detected rate compared to LOD', y = 'Frequency') +
  theme_minimal() + theme(
    plot.title = element_text(hjust = 0.5, size = 14, margin = margin(b = 10)),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)), 
    axis.title.y = element_text(size = 10, margin = margin(r = 10)), 
    axis.text.x = element_text(size = 9), 
    axis.text.y = element_text(size = 9),
    axis.line = element_line(size = 0.5, color = 'black'), 
    panel.grid = element_blank()) + scale_x_continuous(
    breaks = c(-1, seq(5, 100, by = 10)), 
    labels = c('0%', seq(10, 100, by = 10))) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) + coord_cartesian(xlim = c(-5, 105)) 
```

## Olink HT metadata

Extract metadata for Olink HT from additional sources

```{r ht metadata}
# Extract subject_id for meta data 
olink_ht = extract_info_from_column(olink_ht, 'Extra.data', 'subject_id: \\S+', 'subject_id')
# Add sampleID to the column
olink_ht$sampleID = paste0('WEL_', olink_ht$visit, '_', olink_ht$subject_id)
olink_ht = olink_ht %>% mutate(subject_id = str_replace(subject_id, '.*?-', ''))

# Add gender to subjects
subject_info = subject_info %>% rename(subject_id = Subject)
subject_info = subject_info %>% mutate(subject_id = as.character(subject_id))
olink_ht = olink_ht %>% left_join(subject_info %>% select(subject_id, Sex), by = 'subject_id')

# Create metadata
metadata_ht = olink_ht %>% select(DAid, visit, barcode, subject_id, Sex, sampleID) %>% distinct() 
# Add age column into meta data 
subject_info$Birth.date = as.Date(subject_info$Birth.date)
metadata_ht$age = 2015 - as.numeric(format(subject_info$Birth.date[match(metadata_ht$subject_id, subject_info$subject_id)], '%Y'))
```

## Olink HT imputation

Impute missing data 

```{r ht imputation}
# Count data go with barcode bcs there are some dup in patient-visit (sampleID)
ht_count = olink_ht %>% select(UniProt, NPX, barcode)
npx_ht_wide = ht_count %>% pivot_wider(names_from = UniProt, values_from = 'NPX')
npx_ht = npx_ht_wide %>% select(-barcode)
npx_ht_matrix = as.matrix(npx_ht)

# Run the code if data is not yet numeric
# npx_ht = npx_ht %>% mutate(across(everything(), ~ as.numeric(.)))

# Impute missing data
imputed_olink_ht_npx = impute.knn(npx_ht_matrix)
imputed_olink_ht = imputed_olink_ht_npx$data
imputed_olink_ht = as.data.frame(imputed_olink_ht)
```

## Olink UMAP

UMAP for QC

```{r ht umap}
# Plot UMAP
umapxy_ht = umap(imputed_olink_ht, n_neighbors = 15, min_dist = 0.1, metric = 'euclidean')
umap_ht = data.frame(x = umapxy_ht$layout[, 1], y = umapxy_ht$layout[, 2])
umap_ht$barcode = npx_ht_wide$barcode
umap_ht = umap_ht %>% left_join(metadata_ht %>% select(barcode, Sex, visit, subject_id), by = 'barcode')

# UMAP colored by visit
ggplot(umap_ht, aes(x = x, y = y, color = factor(visit))) +
  geom_point(size = 3, alpha = 0.8) +
  labs(title = 'UMAP Olink HT colored by Visit',
    x = 'UMAP1', y = 'UMAP2', color = 'Visit') +
  scale_color_manual(values = c('#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#e41a1c', '#ffff33')) +
  theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
    axis.title = element_text(size = 14), legend.title = element_text(size = 12),
    legend.text = element_text(size = 10))

# UMAP colored by sex
ggplot(umap_ht, aes(x = x, y = y, color = Sex)) + geom_point(size = 3, alpha = 0.8) +
  labs(title = 'UMAP Olink HT colored by Sex', x = 'UMAP1', y = 'UMAP2', color = 'Sex') +
  scale_color_manual(values = c('f' = '#F8766D', 'm' = '#00BFC4')) + theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
    axis.title = element_text(size = 14), legend.title = element_text(size = 12),
    legend.text = element_text(size = 10))

# UMAP colored by patient 
# No legend bcs there are too many
ggplot(umap_ht, aes(x = x, y = y, color = factor(subject_id))) +
  geom_point(size = 3, alpha = 0.8, show.legend = F) +
  labs(title = 'UMAP Olink HT colored by Patient',
       x = 'UMAP1', y = 'UMAP2', color = 'Visit') +
  theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
                          axis.title = element_text(size = 14), legend.title = element_text(size = 12),
                          legend.text = element_text(size = 10))

# UMAP colored by patient separately - assess profile consistency over visits
ggplot(umap_ht, aes(x = x, y = y, color = factor(subject_id))) +
  geom_point(size = 3, alpha = 0.8, show.legend = F) +
  labs(title = 'UMAP Olink HT colored by Patient',
       x = 'UMAP1', y = 'UMAP2', color = 'Visit') +
  facet_wrap(~subject_id) +
  theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
                          axis.title = element_text(size = 14), legend.title = element_text(size = 12),
                          legend.text = element_text(size = 10))
```


## Olink Target metadata

Separate metadata of Olink Target


```{r target metadata}
metadata_target = olink_target %>% select(sampleID, subject_id, visit)
metadata_target = metadata_target %>% mutate(subject_id = str_replace(subject_id, '.*?-', ''))
metadata_target = metadata_target %>% left_join(subject_info %>% select(subject_id, Sex), by = 'subject_id')
```

## Olink Target imputation

Impute missing data 

```{r target imputation}
npx_target = olink_target %>% select(-sampleID, -subject_id, -visit)

# Impute missing data
npx_target_matrix = as.matrix(npx_target)
imputed_olink_target_npx = impute.knn(npx_target_matrix)
imputed_olink_target = imputed_olink_target_npx$data
imputed_olink_target = as.data.frame(imputed_olink_target)
```

## Olink Target UMAP

UMAP for QC

```{r target umap}
# Plot UMAP
umapxy_target = umap(imputed_olink_target, n_neighbors = 15, min_dist = 0.1, metric = 'euclidean')
umap_target = data.frame(x = umapxy_target$layout[, 1], y = umapxy_target$layout[, 2])
umap_target = cbind(umap_target, metadata_target)

# UMAP colored by visit
ggplot(umap_target, aes(x = x, y = y, color = factor(visit))) +
  geom_point(size = 3, alpha = 0.8) +
  labs(title = 'UMAP Olink Target colored by Visit',
       x = 'UMAP1', y = 'UMAP2', color = 'Visit') +
  scale_color_manual(values = c('#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#e41a1c', '#ffff33')) +
#  facet_wrap(~visit) +
  theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
                          axis.title = element_text(size = 14), legend.title = element_text(size = 12),
                          legend.text = element_text(size = 10))

# UMAP colored by sex
ggplot(umap_target, aes(x = x, y = y, color = Sex)) + geom_point(size = 3, alpha = 0.8) +
  labs(title = 'UMAP Olink Target colored by Sex', x = 'UMAP1', y = 'UMAP2', color = 'Sex') +
  scale_color_manual(values = c('f' = '#F8766D', 'm' = '#00BFC4')) + theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
        axis.title = element_text(size = 14), legend.title = element_text(size = 12),
        legend.text = element_text(size = 10))

# UMAP colored by patient
ggplot(umap_target, aes(x = x, y = y, color = factor(subject_id))) +
  geom_point(size = 3, alpha = 0.8, show.legend = F) +
  labs(title = 'UMAP Olink Target colored by Patient ID',
       x = 'UMAP1', y = 'UMAP2', color = 'Visit') +
  #facet_wrap(~visit) +
  theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
                          axis.title = element_text(size = 14), legend.title = element_text(size = 12),
                          legend.text = element_text(size = 10))

# UMAP colored by patient separately - assess profile consistency over visits
ggplot(umap_target, aes(x = x, y = y, color = factor(subject_id))) +
  geom_point(size = 3, alpha = 0.8, show.legend = F) +
  labs(title = 'UMAP Olink Target colored by Patient ID',
       x = 'UMAP1', y = 'UMAP2', color = 'Visit') +
  facet_wrap(~subject_id) +
  theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 16, face = 'bold'),
                          axis.title = element_text(size = 14), legend.title = element_text(size = 12),
                          legend.text = element_text(size = 10))
```

## Olink Target UniProt ID

Replace OlinkID with UniProt ID for comparision

```{r target uniprot}
# Replace OID with Uniprot ID where relevant
uniprot_target = target_id$Uniprot[match(names(imputed_olink_target), target_id$OlinkID)]
# Only replace OID with single value UniProt
new_colnames = names(imputed_olink_target)
for (i in seq_along(new_colnames)) {replacement = uniprot_target[i]
if (!is.na(replacement) && !grepl(',', replacement)) {
  new_colnames[i] = replacement}}
names(imputed_olink_target) = new_colnames
# If there are OID with no or multiple UniProt IDs, filter them out for manual evaluation 
problematic_cases = data.frame(OID = names(imputed_olink_target), Uniprot = uniprot_target
) %>% filter(is.na(Uniprot) | grepl(',', Uniprot))
# Replace OID with UniProt ID after manual inspection 
colnames(imputed_olink_target)[colnames(imputed_olink_target) == 'OID00368'] = 'P29459'
colnames(imputed_olink_target)[colnames(imputed_olink_target) == 'OID00402'] = 'Q8NEV9'
colnames(imputed_olink_target)[colnames(imputed_olink_target) == 'OID00723'] = 'Q29983'
colnames(imputed_olink_target)[colnames(imputed_olink_target) == 'OID01492'] = 'Q11128'
# Extract 1 protein due to its missing Uniprot (cannot find the correct unique Uniprot)
removed_column = imputed_olink_target[['OID01214']]
imputed_olink_target = imputed_olink_target[ , !(colnames(imputed_olink_target) %in% 'OID01214')]
```

## Platform comparison

Compare data between two platforms: metadata and protein detection

```{r platform comparison}
# Metadata comparison
metadata_ht_subset = metadata_ht %>% select(sampleID)
metadata_target_subset = metadata_target %>% select(sampleID)

metadata_shared = inner_join(metadata_ht_subset, metadata_target_subset)
metadata_ht_unique = anti_join(metadata_ht_subset, metadata_target_subset)
metadata_target_unique = anti_join(metadata_target_subset, metadata_ht_subset)

cat('\nThere are', nrow(metadata_shared), 'shared data between Olink HT and Olink Target data sets.\n')
cat('There are', nrow(metadata_ht_unique), 'unique data in Olink HT dataset.\n')
cat('There are', nrow(metadata_target_unique), 'unique data in Olink Target dataset.\n\n')

# Protein detected comparison
protein_shared = intersect(colnames(imputed_olink_ht), colnames(imputed_olink_target))
protein_ht_unique = setdiff(colnames(imputed_olink_ht), colnames(imputed_olink_target))
protein_target_unique = setdiff(colnames(imputed_olink_target), colnames(imputed_olink_ht))

cat('\nNumber of proteins detected in both datasets:', length(protein_shared), '\n')
cat('Number of proteins only detected in Olink HT:', length(protein_ht_unique), '\n')
cat('Number of proteins only detected in Olink Target:', length(protein_target_unique), '\n\n')
```

## Protein correlation

Compare the correlation of measured expression of shared proteins between two platforms

```{r protein corr}
# Insert barcode to map
imputed_olink_ht$barcode = npx_ht_wide$barcode
imputed_olink_ht$sampleID = metadata_ht$sampleID[match(imputed_olink_ht$barcode, metadata_ht$barcode)]
imputed_olink_ht = imputed_olink_ht %>% select(-barcode)

imputed_olink_target$sampleID = metadata_target$sampleID

# Filter for shared sampleID and proteins
imputed_olink_ht_filtered = imputed_olink_ht %>% filter(sampleID %in% metadata_shared$sampleID) %>%
  select(sampleID, all_of(protein_shared))
imputed_olink_target_filtered = imputed_olink_target %>% filter(sampleID %in% metadata_shared$sampleID) %>%
  select(sampleID, all_of(protein_shared))

# Convert to long format to merge
imputed_olink_ht_long = imputed_olink_ht_filtered %>%
  pivot_longer(cols = -sampleID, names_to = 'protein_name', values_to = 'npx_ht')
imputed_olink_target_long = imputed_olink_target_filtered %>%
  pivot_longer(cols = -sampleID, names_to = 'protein_name', values_to = 'npx_target')

# Merge all data
correlation = inner_join(imputed_olink_ht_long, imputed_olink_target_long, by = c('sampleID', 'protein_name'))

# Correlation 
# Protein wise 
correlation = correlation %>% group_by(protein_name) %>%
  mutate(correlation = cor(npx_ht, npx_target)) %>% ungroup()

# Correlation per protein
unique_correlations = correlation %>% distinct(protein_name, correlation) %>%
  mutate(corr_category = case_when(correlation <= 0.4 ~ 'Low', correlation > 0.4 & correlation <= 0.7 ~ 'Mid',
    correlation > 0.7 ~ 'High')) %>% arrange(correlation)

# Count proteins per corr level
category_counts = unique_correlations %>% group_by(corr_category) %>% summarize(count = n())
print(paste('Number of proteins with low correlation (0-0.4):', category_counts$count[category_counts$corr_category == 'Low']))
print(paste('Number of proteins with mid correlation (0.4-0.7):', category_counts$count[category_counts$corr_category == 'Mid']))
print(paste('Number of proteins with high correlation (0.7-1):', category_counts$count[category_counts$corr_category == 'High']))

# Histogram of corr distribution
hist(unique_correlations$correlation, breaks = 20, col = '#377eb8', border = 'white',
     main = 'Distribution of Protein Correlation', xlab = 'Correlation', ylab = 'Frequency')
# Line separated regions
abline(v = 0.4, col = 'red', lty = 2, lwd = 2) 
abline(v = 0.7, col = 'red', lty = 2, lwd = 2) 

# 5 most and least correlated proteins
lowest_proteins = unique_correlations %>% slice(1:5)
highest_proteins = unique_correlations %>% slice((n() - 4):n())

# Correlation plot
for (protein in lowest_proteins$protein_name) {
  protein_data = correlation[correlation$protein_name == protein, ]
  plot_correlation(protein_data, protein)}
for (protein in highest_proteins$protein_name) {
  protein_data = correlation[correlation$protein_name == protein, ]
  plot_correlation(protein_data, protein)}
```

## Olink HT Anova

Perform ANOVA and eta squared to assess the variance explained by metadata of Olink HT

```{r ht anova} 
# Merge data 
imputed_olink_ht_long = imputed_olink_ht_long %>% 
  left_join(select(metadata_ht, sampleID, visit, Sex, age), by = 'sampleID')

# Do with per protein 
# Anova
anova_result = aov(npx_ht ~ Sex + visit + age, data = imputed_olink_ht_long)
summary(anova_result)

# ETA squared
eta_squared_result = eta_squared(anova_result)
```






